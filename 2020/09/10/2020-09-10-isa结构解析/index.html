<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="æ‚„æ‚„çš„-å¼€å¿ƒğŸ˜„"><title>isaç»“æ„è§£æ | Leisure</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/normalize.css/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/pure-min.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><script type="text/javascript" src="//cdn.jsdelivr.net/npm/clipboard/dist/clipboard.min.js"></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.js"></script><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.css"><meta name="generator" content="Hexo 5.2.0"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">isaç»“æ„è§£æ</h1><a id="logo" href="/.">Leisure</a><p class="description"></p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> é¦–é¡µ</i></a><a href="/archives/"><i class="fa fa-archive"> å½’æ¡£</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">isaç»“æ„è§£æ</h1><div class="post-meta">2020-09-10<span> | </span><span class="category"><a href="/categories/iOS%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/">iOSåº•å±‚åŸç†</a></span></div><div class="post-content"><h4 id="1-isaåˆå§‹åŒ–"><a href="#1-isaåˆå§‹åŒ–" class="headerlink" title="1. isaåˆå§‹åŒ–"></a>1. isaåˆå§‹åŒ–</h4><p>åœ¨ <a href="%5Bhttps://www.jianshu.com/p/d4091f8a703a%5D(https://www.jianshu.com/p/d4091f8a703a)">iOS allocåŸç†åˆ†æ</a> ä¸­ä¼š <code>initInstanceIsa</code>ä¸­åˆå§‹åŒ–isaï¼Œæºç å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">inline void </span><br><span class="line">objc_object::initIsa(Class cls, bool nonpointer, bool hasCxxDtor) </span><br><span class="line">&#123; </span><br><span class="line">    ASSERT(!isTaggedPointer()); </span><br><span class="line">    </span><br><span class="line">    if (!nonpointer) &#123;</span><br><span class="line">        isa &#x3D; isa_t((uintptr_t)cls);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        ASSERT(!DisableNonpointerIsa);</span><br><span class="line">        ASSERT(!cls-&gt;instancesRequireRawIsa());</span><br><span class="line"></span><br><span class="line">        isa_t newisa(0);</span><br><span class="line"></span><br><span class="line">#if SUPPORT_INDEXED_ISA</span><br><span class="line">        ASSERT(cls-&gt;classArrayIndex() &gt; 0);</span><br><span class="line">        newisa.bits &#x3D; ISA_INDEX_MAGIC_VALUE;</span><br><span class="line">        &#x2F;&#x2F; isa.magic is part of ISA_MAGIC_VALUE</span><br><span class="line">        &#x2F;&#x2F; isa.nonpointer is part of ISA_MAGIC_VALUE</span><br><span class="line">        newisa.has_cxx_dtor &#x3D; hasCxxDtor;</span><br><span class="line">        newisa.indexcls &#x3D; (uintptr_t)cls-&gt;classArrayIndex();</span><br><span class="line">#else</span><br><span class="line">        newisa.bits &#x3D; ISA_MAGIC_VALUE;</span><br><span class="line">        &#x2F;&#x2F; isa.magic is part of ISA_MAGIC_VALUE</span><br><span class="line">        &#x2F;&#x2F; isa.nonpointer is part of ISA_MAGIC_VALUE</span><br><span class="line">        newisa.has_cxx_dtor &#x3D; hasCxxDtor;</span><br><span class="line">        newisa.shiftcls &#x3D; (uintptr_t)cls &gt;&gt; 3;</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; This write must be performed in a single store in some cases</span><br><span class="line">        &#x2F;&#x2F; (for example when realizing a class because other threads</span><br><span class="line">        &#x2F;&#x2F; may simultaneously try to use the class).</span><br><span class="line">        &#x2F;&#x2F; fixme use atomics here to guarantee single-store and to</span><br><span class="line">        &#x2F;&#x2F; guarantee memory order w.r.t. the class index table</span><br><span class="line">        &#x2F;&#x2F; ...but not too atomic because we don&#39;t want to hurt instantiation</span><br><span class="line">        isa &#x3D; newisa;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#96;&#96;&#96;  </span><br><span class="line">åˆ†æï¼š  </span><br><span class="line">å¦‚æœæ²¡æœ‰å¼€å¯æŒ‡é’ˆä¼˜åŒ–ï¼Œåˆ™ç›´æ¥å°†ç±»èµ‹å€¼ç»™isaæŒ‡é’ˆï¼Œå³isaç›´æ¥æŒ‡å‘è¯¥ç±»ï¼Œ&#96;isa &#x3D; isa_t((uintptr_t)cls);&#96;ã€‚  </span><br><span class="line">å¦‚æœå¼€å¯æŒ‡é’ˆä¼˜åŒ–ï¼Œåˆ™ä»¥å¦ä¸€ç§å½¢å¼åˆå§‹åŒ–isaæŒ‡é’ˆã€‚</span><br><span class="line"></span><br><span class="line">#### 2. isaç»“æ„</span><br><span class="line">æ ¹æ®æºç å¯çŸ¥isaç±»å‹ä¸º&#96;isa_t&#96;è”åˆä½“ç±»å‹ï¼Œæºç å¦‚ä¸‹ï¼š  </span><br><span class="line">&#96;&#96;&#96;  </span><br><span class="line">union isa_t &#123;</span><br><span class="line">    isa_t() &#123; &#125;</span><br><span class="line">    isa_t(uintptr_t value) : bits(value) &#123; &#125;</span><br><span class="line"></span><br><span class="line">    Class cls;</span><br><span class="line">    uintptr_t bits;</span><br><span class="line">#if defined(ISA_BITFIELD)</span><br><span class="line">    struct &#123;</span><br><span class="line">        ISA_BITFIELD;  &#x2F;&#x2F; defined in isa.h</span><br><span class="line">    &#125;;</span><br><span class="line">#endif</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"># if __arm64__</span><br><span class="line">#   define ISA_MASK        0x0000000ffffffff8ULL</span><br><span class="line">#   define ISA_MAGIC_MASK  0x000003f000000001ULL</span><br><span class="line">#   define ISA_MAGIC_VALUE 0x000001a000000001ULL</span><br><span class="line">#   define ISA_BITFIELD                                                      \</span><br><span class="line">      uintptr_t nonpointer        : 1;                                       \</span><br><span class="line">      uintptr_t has_assoc         : 1;                                       \</span><br><span class="line">      uintptr_t has_cxx_dtor      : 1;                                       \</span><br><span class="line">      uintptr_t shiftcls          : 33; &#x2F;*MACH_VM_MAX_ADDRESS 0x1000000000*&#x2F; \</span><br><span class="line">      uintptr_t magic             : 6;                                       \</span><br><span class="line">      uintptr_t weakly_referenced : 1;                                       \</span><br><span class="line">      uintptr_t deallocating      : 1;                                       \</span><br><span class="line">      uintptr_t has_sidetable_rc  : 1;                                       \</span><br><span class="line">      uintptr_t extra_rc          : 19</span><br></pre></td></tr></table></figure>
<blockquote>
<p>è”åˆä½“ï¼šåˆåå…±ç”¨ä½“ï¼Œå¯ä»¥åŒ…å«å¤šä¸ªä¸åŒç±»å‹çš„æˆå‘˜ã€‚ç»“æ„ä½“å’Œè”åˆä½“çš„åŒºåˆ«åœ¨äºç»“æ„ä½“çš„å„ä¸ªæˆå‘˜ä¼šå æ®ä¸åŒçš„å†…å­˜ï¼Œè€Œè”åˆä½“çš„æˆå‘˜å…±ç”¨ä¸€å—å†…å­˜ï¼Œå„ä¸ªæˆå‘˜çš„é¦–åœ°å€ç›¸åŒã€‚</p>
</blockquote>
<p>æ‰€ä»¥åœ¨<code>isa_t</code>è”åˆä½“ä¸­<code>Class cls</code>å’Œ<code>uintptr_t bits</code>æ˜¯äº’æ–¥çš„ã€‚<br>ç”± <code>typedef unsigned long           uintptr_t;</code> æ‰€çŸ¥ï¼Œbitså æ®8å­—èŠ‚ï¼Œå…±64ä½ï¼Œ64ä½ä¸­å­˜å‚¨çš„å³<code>ISA_BITFIELD</code>å®å®šä¹‰ä¸­çš„å†…å®¹ã€‚</p>
<p><code>uintptr_t nonpointer        : 1;  </code> æ˜¯å¦å¯¹isaæŒ‡é’ˆå¼€å¯ä¼˜åŒ–ã€‚0:çº¯isaæŒ‡é’ˆ 1:ä¸åªç±»å¯¹è±¡åœ°å€ï¼Œè¿˜åŒ…æ‹¬äº†ç±»ä¿¡æ¯ï¼Œå¯¹è±¡å¯¹å¼•ç”¨è®¡æ•°ç­‰ã€‚<br><code>uintptr_t has_assoc        : 1;  </code> å…³è”å¯¹è±¡æ ‡è¯†ä½ 0:æ²¡æœ‰ 1:å­˜åœ¨ã€‚<br><code>uintptr_t has_cxx_dtor    : 1;  </code> æ˜¯å¦æœ‰c++æˆ–objcçš„ææ„å‡½æ•° å¦‚æœæœ‰åˆ™éœ€è¦è°ƒç”¨ææ„é€»è¾‘ï¼Œå¦‚æœæ²¡æœ‰åˆ™å¯ä»¥æ›´å¿«é‡Šæ”¾å¯¹è±¡ã€‚<br><code>uintptr_t shiftcls          : 33;  </code> å­˜å‚¨ç±»æŒ‡é’ˆçš„å€¼ï¼Œå¼€å¯æŒ‡é’ˆä¼˜åŒ–æ—¶ï¼Œæœ‰33ä½ç”¨æ¥å­˜æ”¾ç±»æŒ‡é’ˆã€‚<br><code>uintptr_t magic             : 6;  </code> ç”¨äºè°ƒè¯•å™¨åˆ¤æ–­å½“å‰å¯¹è±¡æ˜¯çœŸçš„å¯¹è±¡è¿˜æ˜¯æœªåˆå§‹åŒ–çš„ç©ºé—´ã€‚<br><code>uintptr_t weakly_referenced : 1;  </code> æ ‡å¿—å¯¹è±¡æ˜¯å¦è¢«æŒ‡å‘æˆ–æ›¾ç»æŒ‡å‘ä¸€ä¸ªARCçš„å¼±å˜é‡ï¼Œæ²¡æœ‰å¼±å¼•ç”¨çš„å¯¹è±¡å¯ä»¥æ›´å¿«çš„é‡Šæ”¾ã€‚<br><code>uintptr_t deallocating      : 1; </code> æ ‡å¿—å¯¹è±¡æ˜¯å¦æ­£åœ¨é‡Šæ”¾å†…å­˜ã€‚<br><code>uintptr_t has_sidetable_rc  : 1; </code> å½“å¼•ç”¨è®¡æ•°å¤§äº10æ—¶ï¼Œåˆ™éœ€è¦å€ŸåŠ©è¯¥å˜é‡å­˜å‚¨è¿›ä½ã€‚<br><code>uintptr_t extra_rc          : 19 </code> è¡¨ç¤ºè¯¥å¯¹è±¡çš„å¼•ç”¨è®¡æ•°å‡1ï¼Œå¦‚æœå¼•ç”¨è®¡æ•°ä¸º10ï¼Œåˆ™extra_rcä¸º9ï¼Œå¦‚æœå¼•ç”¨è®¡æ•°å¤§äº10ï¼Œåˆ™éœ€è¦å€ŸåŠ©has_sidetable_rcã€‚</p>
<h4 id="3-isaä¸ç±»å…³è”"><a href="#3-isaä¸ç±»å…³è”" class="headerlink" title="3. isaä¸ç±»å…³è”"></a>3. isaä¸ç±»å…³è”</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- (Class)class &#123;</span><br><span class="line">    return object_getClass(self);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è·å–ç±»å¯¹è±¡ï¼Œå…ƒç±»ä¹Ÿæ˜¯ç‰¹æ®Šçš„ç±»å¯¹è±¡</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">Class object_getClass(id obj)</span><br><span class="line">&#123;</span><br><span class="line">    if (obj) return obj-&gt;getIsa();</span><br><span class="line">    else return Nil;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">inline Class </span><br><span class="line">objc_object::getIsa() </span><br><span class="line">&#123;</span><br><span class="line">    if (fastpath(!isTaggedPointer())) return ISA();</span><br><span class="line"></span><br><span class="line">    extern objc_class OBJC_CLASS_$___NSUnrecognizedTaggedPointer;</span><br><span class="line">    uintptr_t slot, ptr &#x3D; (uintptr_t)this;</span><br><span class="line">    Class cls;</span><br><span class="line"></span><br><span class="line">    slot &#x3D; (ptr &gt;&gt; _OBJC_TAG_SLOT_SHIFT) &amp; _OBJC_TAG_SLOT_MASK;</span><br><span class="line">    cls &#x3D; objc_tag_classes[slot];</span><br><span class="line">    if (slowpath(cls &#x3D;&#x3D; (Class)&amp;OBJC_CLASS_$___NSUnrecognizedTaggedPointer)) &#123;</span><br><span class="line">        slot &#x3D; (ptr &gt;&gt; _OBJC_TAG_EXT_SLOT_SHIFT) &amp; _OBJC_TAG_EXT_SLOT_MASK;</span><br><span class="line">        cls &#x3D; objc_tag_ext_classes[slot];</span><br><span class="line">    &#125;</span><br><span class="line">    return cls;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">inline Class </span><br><span class="line">objc_object::ISA() </span><br><span class="line">&#123;</span><br><span class="line">    ASSERT(!isTaggedPointer()); </span><br><span class="line">#if SUPPORT_INDEXED_ISA</span><br><span class="line">    if (isa.nonpointer) &#123;</span><br><span class="line">        uintptr_t slot &#x3D; isa.indexcls;</span><br><span class="line">        return classForIndex((unsigned)slot);</span><br><span class="line">    &#125;</span><br><span class="line">    return (Class)isa.bits;</span><br><span class="line">#else</span><br><span class="line">    return (Class)(isa.bits &amp; ISA_MASK);</span><br><span class="line">#endif</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è·å–ç±»å¯¹è±¡ï¼Œå³è·å–isaçš„æŒ‡å‘ã€‚étaggedPointerçš„isaï¼Œæœ€ç»ˆè¿”å›<code>return (Class)(isa.bits &amp; ISA_MASK);</code></p>
<h4 id="4-å¯¹è±¡çš„æœ¬è´¨"><a href="#4-å¯¹è±¡çš„æœ¬è´¨" class="headerlink" title="4. å¯¹è±¡çš„æœ¬è´¨"></a>4. å¯¹è±¡çš„æœ¬è´¨</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;main.m</span><br><span class="line">#import &lt;Foundation&#x2F;Foundation.h&gt;</span><br><span class="line">#import &quot;LSPerson.h&quot;</span><br><span class="line"></span><br><span class="line">struct Person &#123;</span><br><span class="line">    char * name;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">int main(int argc, const char * argv[]) &#123;</span><br><span class="line">    @autoreleasepool &#123;</span><br><span class="line">        LSPerson *p1 &#x3D; [[LSPerson alloc] init]; </span><br><span class="line">    &#125;</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é€šè¿‡<code>clang -rewrite-objc main.m -o main.cpp</code>å°†ä»¥ä¸Šæ–‡ä»¶è½¬æˆc++æ–‡ä»¶<br> <code>NSObject</code>åº•å±‚ç»“æ„ä¸º</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">struct NSObject_IMPL &#123;</span><br><span class="line">	Class isa;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>LSPersonåº•å±‚ç»“æ„ä¸º</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">struct LSPerson_IMPL &#123;</span><br><span class="line">	struct NSObject_IMPL NSObject_IVARS;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>å› ä¸ºLSPersonå¹¶æ²¡æœ‰å…¶ä»–æˆå‘˜å˜é‡ï¼Œåˆ™ç›´æ¥ç»§æ‰¿è‡ªNSObjectçš„ç»“æ„ä½“ï¼Œæ‰€ä»¥ç»§æ‰¿è‡ªNSObjectçš„å¯¹è±¡éƒ½ä¼šæœ‰isaæŒ‡é’ˆã€‚</p>
<p>å±æ€§çš„setteræ–¹æ³•éƒ½ä¼šè°ƒç”¨<code>objc_setProperty</code>å‡½æ•°</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">void objc_setProperty(id self, SEL _cmd, ptrdiff_t offset, id newValue, BOOL atomic, signed char shouldCopy) </span><br><span class="line">&#123;</span><br><span class="line">    bool copy &#x3D; (shouldCopy &amp;&amp; shouldCopy !&#x3D; MUTABLE_COPY);</span><br><span class="line">    bool mutableCopy &#x3D; (shouldCopy &#x3D;&#x3D; MUTABLE_COPY);</span><br><span class="line">    reallySetProperty(self, _cmd, newValue, offset, atomic, copy, mutableCopy);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">static inline void reallySetProperty(id self, SEL _cmd, id newValue, ptrdiff_t offset, bool atomic, bool copy, bool mutableCopy)</span><br><span class="line">&#123;</span><br><span class="line">    if (offset &#x3D;&#x3D; 0) &#123;</span><br><span class="line">        object_setClass(self, newValue);</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    id oldValue;</span><br><span class="line">    id *slot &#x3D; (id*) ((char*)self + offset);</span><br><span class="line"></span><br><span class="line">    if (copy) &#123;</span><br><span class="line">        newValue &#x3D; [newValue copyWithZone:nil];</span><br><span class="line">    &#125; else if (mutableCopy) &#123;</span><br><span class="line">        newValue &#x3D; [newValue mutableCopyWithZone:nil];</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        if (*slot &#x3D;&#x3D; newValue) return;</span><br><span class="line">        newValue &#x3D; objc_retain(newValue);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (!atomic) &#123;</span><br><span class="line">        oldValue &#x3D; *slot;</span><br><span class="line">        *slot &#x3D; newValue;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        spinlock_t&amp; slotlock &#x3D; PropertyLocks[slot];</span><br><span class="line">        slotlock.lock();</span><br><span class="line">        oldValue &#x3D; *slot;</span><br><span class="line">        *slot &#x3D; newValue;        </span><br><span class="line">        slotlock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    objc_release(oldValue);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ€»ç»“ä¸ºretainæ–°å€¼ï¼Œreleaseæ—§å€¼ã€‚</p>
</div><div class="tags"><a href="/tags/iOS%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/"><i class="fa fa-tag"></i>iOSåº•å±‚åŸç†</a></div><div class="post-nav"><a class="pre" href="/2020/09/13/2020-09-13-iOS%20%E7%B1%BB%E7%9A%84%E7%BB%93%E6%9E%84%E5%88%86%E6%9E%90/">iOS ç±»çš„ç»“æ„åˆ†æ</a><a class="next" href="/2020/09/06/2020-09-06-iOS%20alloc%E5%8E%9F%E7%90%86/">iOS allocåŸç†åˆ†æ</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://ugpass.github.io"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> åˆ†ç±»</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/OpenGL/">OpenGL</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/OpenGL-ES/">OpenGL ES</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/OpenGL-ES/GLSL/">GLSL</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/React-Native/">React Native</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/WebRTC%E5%AD%A6%E4%B9%A0/">WebRTCå­¦ä¹ </a></li><li class="category-list-item"><a class="category-list-link" href="/categories/iOS/">iOS</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/iOS/Cocoapods/">Cocoapods</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/iOS%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/">iOSåº•å±‚åŸç†</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%94%9F%E6%B4%BB/">ç”Ÿæ´»</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> æ ‡ç­¾</i></div><div class="tagcloud"><a href="/tags/%E7%94%9F%E6%B4%BB/" style="font-size: 15px;">ç”Ÿæ´»</a> <a href="/tags/React-Native/" style="font-size: 15px;">React Native</a> <a href="/tags/iOS/" style="font-size: 15px;">iOS</a> <a href="/tags/OpenGL/" style="font-size: 15px;">OpenGL</a> <a href="/tags/Cocoapods/" style="font-size: 15px;">Cocoapods</a> <a href="/tags/OpenGL-ES/" style="font-size: 15px;">OpenGL ES</a> <a href="/tags/WebRTC%E5%AD%A6%E4%B9%A0/" style="font-size: 15px;">WebRTCå­¦ä¹ </a> <a href="/tags/iOS%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/" style="font-size: 15px;">iOSåº•å±‚åŸç†</a> <a href="/tags/GLSL/" style="font-size: 15px;">GLSL</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> æœ€è¿‘æ–‡ç« </i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2020/10/15/2020-10-15-iOS%20APP%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/">iOS APPå¯åŠ¨æµç¨‹</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/09/24/2020-09-24-objc_msgSend%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90(%E4%B8%89)/">objc_msgSendæºç è§£æ(ä¸‰)</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/09/23/2020-09-23-objc_msgSend%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90(%E4%BA%8C)/">objc_msgSendæºç è§£æ(äºŒ)</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/09/20/2020-09-20-objc_msgSend%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90(%E4%B8%80)/">objc_msgSendæºç è§£æ(ä¸€)</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/09/18/2020-09-18-iOS%20cache_t%E7%BB%93%E6%9E%84%E5%88%86%E6%9E%90/">iOS cache_tç»“æ„åˆ†æ</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/09/15/2020-09-15-iOS%20%E7%B1%BB%E7%9A%84%E7%BB%93%E6%9E%84%E5%88%86%E6%9E%90(%E4%BA%8C)/">iOS ç±»çš„ç»“æ„åˆ†æ(äºŒ)</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/09/13/2020-09-13-iOS%20%E7%B1%BB%E7%9A%84%E7%BB%93%E6%9E%84%E5%88%86%E6%9E%90/">iOS ç±»çš„ç»“æ„åˆ†æ</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/09/10/2020-09-10-isa%E7%BB%93%E6%9E%84%E8%A7%A3%E6%9E%90/">isaç»“æ„è§£æ</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/09/06/2020-09-06-iOS%20alloc%E5%8E%9F%E7%90%86/">iOS allocåŸç†åˆ†æ</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/08/02/2020-08-02-%E7%BF%BB%E8%BD%AC%E7%BA%B9%E7%90%86%E7%9A%845%E7%A7%8D%E6%96%B9%E5%BC%8F/">ç¿»è½¬çº¹ç†çš„5ç§æ–¹å¼</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> å‹æƒ…é“¾æ¥</i></div></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright Â© 2020 <a href="/." rel="nofollow">Leisure.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.css"><script type="text/javascript" src="/js/copycode.js" successtext="å¤åˆ¶æˆåŠŸ!"></script><link rel="stylesheet" type="text/css" href="/css/copycode.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>